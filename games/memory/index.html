<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Endless Memory Game</title>
  <style>
    body {
      margin: 0;
      background: linear-gradient(120deg, #89f7fe 0%, #66a6ff 100%);
      font-family: 'Segoe UI', Arial, sans-serif;
      height: 100vh; width: 100vw;
      overflow: hidden;
      display: flex; align-items: center; justify-content: center;
    }
    .container {
      width: 97vw; max-width: 900px;
      height: 95vh; max-height: 770px;
      background: rgba(255,255,255,.97);
      border-radius: 24px;
      box-shadow: 0 8px 32px rgba(30,30,100,0.13);
      display: flex; flex-direction:column; align-items:center; padding: 20px;
      position: relative; overflow: hidden;
    }
    .header { 
      width:100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px; 
    }
    .header h1 {
      font-size: 2em;
      background: linear-gradient(90deg, #3673ea 35%, #0ac5b8 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
      font-weight: 800;
      letter-spacing: 2px;
    }
    .btn {
      border: none;
      background: #fa5e43;
      color: #fff;
      font-weight: 700;
      font-size: 1em;
      border-radius: 13px;
      padding: 7px 24px;
      margin: 0 6px;
      cursor: pointer;
      transition: background 0.18s, transform 0.16s;
      box-shadow: 0 2px 6px #fd7e4d26;
    }
    .btn:hover { background: #ff835b; color: #fff; transform: scale(1.07); }
    .levels {
      margin-bottom: 8px;
      display: flex; gap: 6px; justify-content:center;
    }
    .levels button {
      background: #66a6ff;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 6px 17px;
      font-size: 1em;
      font-weight:700;
      cursor: pointer;
      opacity: 0.70;
      transition: background 0.18s,opacity 0.11s;
    }
    .levels .active {
      background: #5549ad;
      opacity:1;
    }
    .stats {
      color: #204073;
      font-size: 1em;
      margin-bottom: 10px;
      display: flex; flex-wrap:wrap; gap: 14px; align-items: center; justify-content:center;
    }
    .stat-label { font-weight: 500;}
    #level-indicator {
      font-size: 1.07em;
      background: #ffe082;
      color: #335;
      font-weight: 700;
      padding: 4px 12px;
      border-radius: 12px;
      margin-right: 10px;
      box-shadow: 0 1.5px 8px #ffe08282;
      letter-spacing: 1.2px;
      margin-bottom:2px;
    }
    .board {
      flex: 1 1 auto;
      width: 98%;
      display: grid;
      gap: 1vw;
      place-content:center;
      padding-bottom:8px;padding-top:0;
      overflow:auto;
      border-radius:18px;
      margin-bottom: 0;
      justify-items:center;
      align-items:center;
    }
    .card {
      aspect-ratio:3/4; width:100%; max-width: 11vw; min-width:53px; max-height:120px; min-height:55px;
      perspective: 600px;
      border-radius: 14px;
      cursor: pointer;
      user-select: none;
      display: block;
    }
    .card-inner {
      width: 100%; height: 100%; border-radius: 14px;
      transition: transform 0.42s cubic-bezier(.43,2.12,.63,.98);
      transform-style: preserve-3d;
      position: relative;
    }
    .card.flip .card-inner { transform: rotateY(180deg);}
    .card.matched .card-inner { animation: matchGlow 0.70s 1; box-shadow: 0 0 22px #fc0,0 1px 11px #aaa6;}
    @keyframes matchGlow {0%{box-shadow:0 0 10px 0 #fc0;}100%{box-shadow:0 0 34px 8px #fc0;}}
    .card-front, .card-back {
      position:absolute;width:100%;height:100%;border-radius:14px;
      display:grid;place-items:center;font-size:clamp(1.1em,6vw,3.1em);backface-visibility: hidden;
      overflow:hidden;
    }
    .card-front { background:#fff; color:#5549ad; box-shadow:0 4px 16px #b7cef6aa;z-index:2;transform:rotateY(180deg);}
    .card-back { background: linear-gradient(140deg,#222f5e 70%,#6bbafe 100%); color:#ffe56b;box-shadow:0 2px 8px #274b8966;z-index:1;}
    #message {height:32px;margin-top:6px;margin-bottom:4px;color:#17c383;font-weight:700;letter-spacing:1px;font-size:1.08em;}
    /* SCOREBOARD PANEL */
    .scoreboard-modal {
      display: none; flex-direction: column;
      position: absolute; left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      background: #f7faeeea;
      border-radius: 18px;
      box-shadow: 0 4px 28px #0063b972, 0 1.5px 4.5px #aaa6;
      width: 340px; max-width:96vw; min-width: 190px;
      padding: 23px 18px 18px 18px;
      z-index: 50;
      animation: popScore 0.5s;
    }
    @keyframes popScore {0%{scale:0.7;opacity:0;}95%{scale:1.05;}100%{scale:1;opacity:1;}}
    .scoreboard-modal h3 {margin:0 0 10px 0;text-align:center;color:#114c98;}
    .scoreboard-table {width:100%;border-collapse:collapse;margin:0 0 8px 0;}
    .scoreboard-table th, .scoreboard-table td {
      padding:7px 4px;text-align:left;font-size:1em;border-radius:6px;
    }
    .scoreboard-table th {background:#e6eaf8;color:#124f63;}
    .scoreboard-table td {background:#fff;}
    .scoreboard-table tr.top1 td {background:linear-gradient(93deg,#ffe082 60%,#fff);}
    .scoreboard-table tr.top2 td {background:linear-gradient(90deg,#cfd8dc 60%,#fff);}
    .scoreboard-table tr.top3 td {background:linear-gradient(90deg,#bfa36b 30%,#fff);}
    .scoreboard-table tr.you td {background:#bbffd7;}
    .scoreboard-controls {text-align:center;}
    .scoreboard-controls button {background:#0d8b43;color:#fff;font-weight:600;border:none;padding:7px 22px;margin:0 3px;border-radius:14px;}
    .scoreboard-controls button.close-btn {background:#e84545;}
    @media (max-width:600px) {
      .container { max-height:99vh; padding:7px 1vw;}
      .board {gap:2vw;}
      .card {min-width:41px;max-width:15vw;min-height:31px;max-height:13vw;}
    }
    /* Name Submission */
    .name-submit-row { width: 99%; display: flex; align-items: center; justify-content: center; margin-top: 7px;}
    #player-name { border-radius:8px; padding:7px; width:148px; font-size:1em; border:1px solid #b1b7d9;}
    #submit-score {padding:7px 16px;background:#0d8b43;color:#fff;border:none;border-radius:10px;font-weight:600;font-size:1em;margin-left:9px;}
    #submit-score[disabled] {background: #a9a9a9;}
    #show-leaderboard { float:right;padding:6px 15px;font-size:.95em;background:#114c98;color:#fff;border:none; border-radius:11px;}
    #stop-btn {background: #f44336;}
    /* Confetti */
    .confetti {position:fixed;z-index:9999;pointer-events:none;}
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <h1>Endless Memory</h1>
    </div>
    <button class="btn" id="stop-btn" style="display:none;">Stop</button>
  </div>
  <div class="levels" id="level-buttons">
    <button data-size="4" class="active">Easy</button>
    <button data-size="5">Medium</button>
    <button data-size="6">Hard</button>
  </div>
  <div class="stats">
    <span id="level-indicator">Level: Easy</span>
    <span class="stat-label">Moves:</span> <span id="moves">0</span>/<span id="move-limit">30</span>
    <span class="stat-label">Score:</span> <span id="score">0</span>
    <span class="stat-label">High:</span> <span id="highscore">0</span>
    <span class="stat-label">Pairs:</span> <span id="pairs">0</span>/<span id="total-pairs">0</span>
    <button id="show-leaderboard" style="margin-left:auto">🏆 Leaderboard</button>
  </div>
  <div id="message"></div>
  <div class="board" id="game-board"></div>
  <!-- SCOREBOARD -->
  <div id="scoreboard" class="scoreboard-modal">
    <h3>🏆 Global Leaderboard</h3>
    <table class="scoreboard-table">
      <thead><tr><th>Rank</th><th>Name</th><th>Score</th></tr></thead>
      <tbody id="leaderboard-body"></tbody>
    </table>
    <div class="scoreboard-controls">
      <button class="close-btn" onclick="hideScoreboard()">Close</button>
    </div>
  </div>
  <div class="name-submit-row">
    <input type="text" id="player-name" placeholder="Your name..." />
    <button id="submit-score" disabled>Submit Score</button>
  </div>
</div>
<script>
const emojiSets = [
  ["🌸","🎩","💎","🍕","🐱","🍋","🐦","⚽","🔑","🎲","🎈","☕","🚗","🐳","🌵","🍉","✨","🪁"],
  ["🐶","🐻","🚀","🍔","⭐","🍩","🥥","🎹","🦋","🎮","🍓","☂️","🧸","🔮","🌼","📦","🥑","🏀"]
];
const moveLimits = {4:30, 5:50, 6:70};
const levelNames = {4:"Easy",5:"Medium",6:"Hard"};
const minLevel = 4, maxLevel = 6;
let endless = true, gameRunning = true;

const board = document.getElementById('game-board');
const movesSpan = document.getElementById('moves');
const moveLimitSpan = document.getElementById('move-limit');
const scoreSpan = document.getElementById('score');
const highscoreSpan = document.getElementById('highscore');
const pairsSpan = document.getElementById('pairs');
const totalPairsSpan = document.getElementById('total-pairs');
const message = document.getElementById('message');
const levelIndicator = document.getElementById('level-indicator');
let highScores = JSON.parse(localStorage.getItem('memGameHS')||'{}');
let levelBtns = document.querySelectorAll('.levels button');
let gridSize = minLevel, moves=0, matched=0, totalPairs=0, cardsArr =[],flipped=[],lock=false;
let playerNameInput = document.getElementById('player-name');
let submitScoreBtn = document.getElementById('submit-score');
let showLeaderboardBtn = document.getElementById('show-leaderboard');
let scoreboard = document.getElementById('scoreboard'), lbBody = document.getElementById('leaderboard-body');
let stopBtn = document.getElementById('stop-btn');
function getHighScore(level) { return highScores[level] || 0; }
function saveHighScore(level, score) {
  if(!highScores[level]||score>highScores[level]) {
    highScores[level]=score;
    localStorage.setItem('memGameHS',JSON.stringify(highScores));
    return true;
  } return false;
}
function calculateScore(moves,matched,moveLimit) {
  let base = (moveLimit-moves)*10+matched*50;
  return Math.max(0,base);
}
function updateStats() {
  movesSpan.textContent = moves;
  moveLimitSpan.textContent = moveLimits[gridSize];
  scoreSpan.textContent = calculateScore(moves,matched,moveLimits[gridSize]);
  highscoreSpan.textContent = getHighScore(gridSize);
  pairsSpan.textContent = matched;
  totalPairsSpan.textContent = totalPairs;
  submitScoreBtn.disabled = !(matched===totalPairs && playerNameInput.value.trim());
}
function setBoard(size, customLevelName) {
  gridSize = size;
  // update UI
  board.style.gridTemplateColumns = `repeat(${size}, minmax(0,1fr))`;
  board.innerHTML = "";
  levelBtns.forEach(b=>b.classList.remove('active'));
  let sel = Array.from(levelBtns).find(b=>+b.getAttribute('data-size')===gridSize);
  if(sel) sel.classList.add('active');
  // level indicator
  let lLabel = customLevelName ? customLevelName : levelNames[gridSize];
  levelIndicator.textContent = "Level: "+lLabel;
  // set stats
  const neededPairs = (size*size)/2;
  totalPairs=neededPairs;
  matched=0; moves=0; flipped=[]; lock=false;
  updateStats(); submitScoreBtn.disabled=true; message.textContent='';
  // Cards
  let pool = emojiSets[Math.floor(Math.random()*emojiSets.length)].slice();
  while(pool.length<neededPairs) pool=pool.concat(pool);
  let syms=shuffle(pool).slice(0,neededPairs), cardSyms = shuffle([...syms,...syms]);
  cardsArr = [];
  for(let i=0;i<cardSyms.length;i++) {
    let card = createCard(cardSyms[i],i);
    cardsArr.push(card); board.appendChild(card);
  }
}
function createCard(sym,idx) {
  const card = document.createElement('div');
  card.className='card'; card.setAttribute('data-idx',idx);
  card.innerHTML = `<div class="card-inner"><div class="card-front">${sym}</div><div class="card-back">❓</div></div>`;
  card.onclick = ()=>onCardClick(card,sym); return card;
}
function onCardClick(card,sym) {
  if(!gameRunning) return;
  if(lock||card.classList.contains('flip')||card.classList.contains('matched'))return;
  if(moves>=moveLimits[gridSize]) {
    message.textContent="⏱️ Move limit reached!";
    message.style.color='#e43'; return;
  }
  card.classList.add('flip'); flipped.push({el:card,sym});
  if(flipped.length==2) {
    moves++; updateStats();
    if(flipped[0].sym===flipped[1].sym){
      setTimeout(()=>{
        flipped[0].el.classList.add('matched');flipped[1].el.classList.add('matched');
        matched++; updateStats(); flipped=[];
        animateConfetti();
        if(matched===totalPairs) winEffect();
      },430);
    } else {
      lock=true; setTimeout(()=>{
        flipped[0].el.classList.remove('flip');flipped[1].el.classList.remove('flip');flipped=[];
        lock=false;
      },800);
    }
  }
}
function winEffect() {
  let score = calculateScore(moves,matched,moveLimits[gridSize]);
  let beat = saveHighScore(gridSize,score);
  message.textContent = beat ? "✨ New high score!" : "🎉 Finished Level " + levelNames[gridSize] + "!";
  message.style.color = '#17c383';
  submitScoreBtn.disabled = !(playerNameInput.value.trim());
  animateConfettiAll();
  // After 1.7s move to next level in endless mode
  if(endless && gameRunning) {
    setTimeout(() => {
      // Next: increase level (cycle back after max)
      let nextLevel = gridSize < maxLevel ? gridSize+1 : minLevel;
      setBoard(nextLevel);
      loadLeaderboard(nextLevel);
      message.textContent = "Level " + levelNames[nextLevel] + ". Good luck!";
      message.style.color = '#2396ec';
    }, 1700);
  }
}
// Stop/endless logic
stopBtn.onclick = () => {
  endless = false;
  gameRunning = false;
  stopBtn.style.display = "none";
  levelBtns.forEach(b=>b.disabled=false);
  message.textContent = "Endless mode stopped. Select a level or replay!";
};
function startEndlessMode() {
  endless = true; gameRunning = true;
  stopBtn.style.display = "inline-block";
  levelBtns.forEach(b=>b.disabled=true);
  setBoard(gridSize); loadLeaderboard(gridSize);
  message.textContent = "Endless mode (auto advance)!";
  message.style.color = "#31c573";
}

levelBtns.forEach(btn=>{
  btn.onclick=function(){
    if(endless) return; // Don't allow manual during endless
    gridSize = +btn.getAttribute('data-size');
    setBoard(gridSize);
    loadLeaderboard(gridSize);
    message.textContent = "";
  };
});
document.getElementById('level-buttons').addEventListener("dblclick", function(){
  startEndlessMode(); // double-clicking levels row will restart endless
});
// Keyboard shortcut: press "E" to toggle endless mode
document.addEventListener("keydown", e=>{
  if(e.key==="E"||e.key==="e"){startEndlessMode();}
});
playerNameInput.oninput = () => submitScoreBtn.disabled = !(matched===totalPairs && playerNameInput.value.trim());
submitScoreBtn.onclick = () => {
  let name = playerNameInput.value.trim();
  if(!name) return alert("Enter your name");
  let score = calculateScore(moves,matched,moveLimits[gridSize]);
  // Simulated: send to backend API
  // Replace below with your real POST and showLeaderboardUI
  fetch('https://yourapi.example.com/scores',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,score,level:gridSize})})
    .then(res=>res.json()).then(()=>{loadLeaderboard(gridSize);alert('Score submitted!');}).catch(()=>{alert("Demo: no real server.")});
  submitScoreBtn.disabled=true;
};
function loadLeaderboard(level){
  // For demo: simulate leaderboard fetch (replace with real API)
  let fakeLB = [
    {name:"Aanya",score:590},
    {name:"Lucas",score:550},
    {name:playerNameInput.value.trim()||"You",score:calculateScore(moves,matched,moveLimits[gridSize])},
    {name:"Reva",score:410},
    {name:"Sam",score:332}
  ];
  showLeaderboardUI(fakeLB);
}
function showLeaderboardUI(lb) {
  scoreboard.style.display='flex'; lbBody.innerHTML='';
  lb.sort((a,b)=>b.score-a.score);
  lb.forEach((row,i)=>{
    let tr = document.createElement('tr');
    tr.className = i==0?'top1':i==1?'top2':i==2?'top3':'';
    if(row.name.trim().toLowerCase()===playerNameInput.value.trim().toLowerCase())tr.className+=' you';
    tr.innerHTML = `<td>${i+1}</td><td>${row.name}</td><td>${row.score}</td>`;
    lbBody.appendChild(tr);
  });
}
function hideScoreboard(){scoreboard.style.display='none';}
showLeaderboardBtn.onclick = ()=>loadLeaderboard(gridSize);

// Endless mode start
startEndlessMode();

// ---- Confetti for win
function animateConfetti() {
  let c = document.createElement('div');
  c.className = "confetti";
  c.style.left = (Math.random()*80+10) + "%";
  c.style.top = (Math.random()*60+15) + "%";
  c.style.fontSize = "2.0em";
  c.style.animation = "fly 1.2s linear forwards";
  c.textContent = "🎉";
  document.body.appendChild(c);
  setTimeout(()=>c.remove(),900);
}
function animateConfettiAll() {
  for(let i=0;i<14;i++) setTimeout(animateConfetti,i*95);
}
let confettiCSS = document.createElement('style');
confettiCSS.innerHTML = `@keyframes fly{0%{opacity:1;transform:translateY(0)scale(1);}74%{opacity:.6;}100%{opacity:0;transform:translateY(-90px)scale(.9)rotate(9deg);}}`;document.head.appendChild(confettiCSS);

function shuffle(arr) {for(let i=arr.length-1;i>0;i--){let j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}return arr;}
// CLICK outside modal to close (optional)
scoreboard.onclick = function(e){ if(e.target===scoreboard)hideScoreboard(); }
// initial load, manual mode: setBoard(gridSize); loadLeaderboard(gridSize);
</script>
</body>
</html>
