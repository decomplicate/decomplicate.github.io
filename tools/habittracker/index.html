<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Habit Tracker ‚Äî Gamified (Guest or Login)</title>
  <meta name="description" content="Gamified Habit Tracker. Use as Guest (local only) or sign up to save progress across devices. Earn XP, badges, and track streaks." />
  <meta name="keywords" content="habit tracker, habit, gamified, productivity, streaks, badges, xp, firebase" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta property="og:title" content="Habit Tracker ‚Äî Gamified" />
  <meta property="og:description" content="Use as Guest or Sign Up to save progress across devices." />
  <meta name="author" content="EffortlesslyDone" />

  <!-- Firebase SDKs (compat build used for simpler code) -->
  <!-- Replace with modular imports if you prefer -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
  :root{
    --bg: linear-gradient(120deg,#f6d365 0%,#fda085 100%);
    --card: #ffffffdd;
    --indigo:#3F51B5;
    --coral:#FF6B5E;
    --muted:#6b7280;
    --surface:#fff;
    --radius:14px;
    --shadow:0 10px 30px rgba(16,24,40,0.08);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,Segoe UI,Arial;background:var(--bg);color:#112;}
  .app{max-width:980px;margin:28px auto;padding:0 16px;}
  .card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
  header{background:linear-gradient(90deg,var(--indigo),#5b59d6);color:#fff;padding:22px 18px;display:flex;justify-content:space-between;align-items:center}
  header h1{margin:0;font-family:Poppins,Segoe UI;font-weight:700}
  .toolbar {display:flex;gap:10px;align-items:center}
  .btn{background:var(--coral);color:#fff;border:none;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
  .btn.secondary{background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.18)}
  main{display:flex;gap:18px;padding:18px}
  .left{width:360px}
  .panel{background:var(--surface);padding:14px;border-radius:12px;margin-bottom:14px}
  label{display:block;margin:8px 0 6px;font-weight:600}
  input,select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eefb}
  .habits-list{display:flex;flex-direction:column;gap:12px}
  .habit-row{display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px;background:#fbfdff}
  .icon{font-size:26px;width:44px;text-align:center}
  .progress-bar{height:10px;background:#f1f6ff;border-radius:8px;overflow:hidden}
  .progress{height:100%;background:linear-gradient(90deg,var(--indigo),var(--coral));width:0%}
  .actions{display:flex;gap:8px}
  .small{font-size:0.92rem;color:var(--muted)}
  footer{padding:12px;text-align:center;color:var(--muted)}

  /* Auth modal */
  .modal {position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:999}
  .modal .box{width:360px;background:#fff;padding:18px;border-radius:12px}
  .linkish{background:none;border:none;color:var(--indigo);cursor:pointer;font-weight:600}

  /* responsive */
  @media (max-width:900px){ main{flex-direction:column} .left{width:100%} }
header .small {
  color: #FFD700; /* Gold text color for high visibility */
  font-weight: 600;
  font-size: 1rem;
  text-shadow: 0 1px 3px rgba(0,0,0,0.4); /* subtle shadow for contrast */
}
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <header>
        <div>
          <h1>Habit Tracker ‚Ä¢ Gamified</h1>
          <div class="small">Use guest mode or sign up to save across devices</div>
        </div>
        <div class="toolbar" id="userToolbar">
          <div id="signedInfo" style="display:none;color:#fff"></div>
          <button class="btn" id="btnGuest">Continue as Guest</button>
          <button class="btn secondary" id="btnAuth">Login / Sign up</button>
        </div>
      </header>

      <main>
        <!-- left column -->
        <div class="left">
          <div class="panel">
            <h3 style="margin:0">Add Habit</h3>
            <form id="addHabitForm">
              <label for="habitTitle">Name</label>
              <input id="habitTitle" type="text" placeholder="Drink water" required />
              <label for="habitIcon">Emoji</label>
              <select id="habitIcon">
                <option>‚úÖ</option><option>üíß</option><option>üèÉ‚Äç‚ôÄÔ∏è</option><option>üìñ</option><option>üßò‚Äç‚ôÇÔ∏è</option><option>üõå</option>
              </select>
              <label for="habitFreq">Frequency</label>
              <select id="habitFreq"><option value="daily">Daily</option><option value="weekly">Weekly</option></select>
              <label for="habitGoal">Goal</label>
              <input id="habitGoal" type="number" min="1" max="20" value="1" />
              <div style="display:flex;gap:8px;margin-top:10px">
                <button class="btn" type="submit">Add</button>
                <button type="button" class="btn secondary" id="btnClear">Clear Local</button>
              </div>
            </form>
          </div>

          <div class="panel">
            <h3 style="margin:0">Dashboard</h3>
            <div class="small" id="motivationPhrase">Small daily improvements lead to big results.</div>
            <div style="margin-top:10px" class="small">Level progress (total completions)</div>
            <div style="height:12px;background:#f0f4ff;border-radius:8px;overflow:hidden;margin:8px 0">
              <div id="levelFill" style="height:100%;width:0%;background:linear-gradient(90deg,var(--indigo),var(--coral))"></div>
            </div>
            <div style="margin-top:10px" id="habitsContainer" class="habits-list"></div>
          </div>

          <div class="panel">
            <h3 style="margin:0">Badges</h3>
            <div id="badgeContainer" class="small" style="margin-top:8px">No badges yet ‚Äî earn streaks to unlock awards.</div>
          </div>
        </div>

        <!-- right column -->
        <div style="flex:1">
          <div class="panel">
            <h3 style="margin:0">Progress Chart (last 14 days)</h3>
            <canvas id="chartCanvas" style="width:100%;height:220px;margin-top:12px"></canvas>
          </div>

          <div class="panel" id="achPanel">
            <h3 style="margin:0">Achievements</h3>
            <div id="achList" style="margin-top:8px" class="small">No achievements yet.</div>
          </div>

          <div class="panel">
            <h3 style="margin:0">About</h3>
            <p class="small" style="margin:8px 0">Guest mode stores data locally (per browser). Sign up to store data in the cloud and access across devices.</p>
            <p class="small">Contact: <a href="mailto:decomplicate001@gmail.com">decomplicate001@gmail.com</a></p>
          </div>


  <div class="promo">
    For more automation tools visit:<br>
    <b><a href="https://effortlesslydone.com/" target="_blank">Effortless Automation</a></b><br>
     </div>
</div>

        </div>
      </main>

      <footer class="small" style="text-align:center;padding:12px">¬© 2025 EffortlesslyDone</footer>
    </div>
  </div>

  <!-- auth modal -->
  <div id="authModal" class="modal" style="display:none">
    <div class="box">
      <h3 id="authTitle">Login</h3>
      <div id="authForms">
        <div id="loginForm">
          <label for="loginEmail">Email</label>
          <input id="loginEmail" type="email" />
          <label for="loginPass">Password</label>
          <input id="loginPass" type="password" />
          <div style="display:flex;gap:8px;margin-top:10px">
            <button class="btn" id="btnLogin">Login</button>
            <button class="btn secondary" id="btnSwitchToSignup">Sign Up</button>
          </div>
          <div style="margin-top:10px"><button class="linkish" id="btnForgot">Forgot password?</button></div>
        </div>

        <div id="signupForm" style="display:none">
          <label for="signupEmail">Email</label>
          <input id="signupEmail" type="email" />
          <label for="signupPass">Password</label>
          <input id="signupPass" type="password" />
          <div style="display:flex;gap:8px;margin-top:10px">
            <button class="btn" id="btnSignup">Create Account</button>
            <button class="btn secondary" id="btnSwitchToLogin">Back to Login</button>
          </div>
        </div>

        <div id="forgotForm" style="display:none">
          <label for="forgotEmail">Enter your email</label>
          <input id="forgotEmail" type="email" />
          <div style="display:flex;gap:8px;margin-top:10px">
            <button class="btn" id="btnSendReset">Send Reset Email</button>
            <button class="btn secondary" id="btnForgotBack">Back</button>
          </div>
        </div>
      </div>
      <div style="text-align:right;margin-top:12px"><button class="linkish" id="btnCloseAuth">Close</button></div>
    </div>
  </div>

<script>
/* ========================
  Gamified Habit Tracker
  - Guest mode uses localStorage under key HABIT_GUEST
  - Auth mode uses Firebase Auth + Firestore under collection "users/{uid}/data"
  - Paste your Firebase config below into FIREBASE CONFIG area to enable login/signup
======================== */

/* ---------- CONFIG ---------- */
const LOCAL_KEY = 'HABIT_GUEST_V1';
const FIRESTORE_USER_DOC = 'user_data'; // doc id inside users collection

/* ========== FIREBASE SETUP ==========
  1) Create Firebase project -> Add Web App -> copy config
  2) In Firebase console: Authentication -> enable Email/Password
  3) In Firebase console: Firestore Database -> create in test mode (or locked rules)
  4) Replace the firebaseConfig object below with your project config
===================================== */

/* ====== FIREBASE CONFIG (replace with your values) ======
const firebaseConfig = {
  apiKey: "AIza....",
  authDomain: "YOUR-PROJECT.firebaseapp.com",
  projectId: "YOUR-PROJECT-ID",
  storageBucket: "YOUR-PROJECT.appspot.com",
  messagingSenderId: "1234567890",
  appId: "1:123456789:web:abcdef"
};
============================================================ */

let firebaseEnabled = false;
try {
  // If firebase is loaded, we can initialize later after checking config
  firebaseEnabled = typeof firebase !== 'undefined' && !!firebase;
} catch(e){ firebaseEnabled = false; }

/* ---------- state ---------- */
let isGuest = true;
let currentUser = null; // firebase user uid

/* ---------- utility ---------- */
function $(sel){ return document.querySelector(sel); }
function $all(sel){ return Array.from(document.querySelectorAll(sel)); }
function todayKey(){ return new Date().toISOString().slice(0,10); }
function weekKey(){ let d=new Date(); d.setHours(0,0,0,0); d.setDate(d.getDate()-d.getDay()); return d.toISOString().slice(0,10); }
function capitalize(s){ return s.charAt(0).toUpperCase() + s.slice(1); }

/* ---------- default sample data ---------- */
const SAMPLE_HABITS = [
  { title: "Drink Water", icon:"üíß", frequency:"daily", goal:8, checkedDays:[], streakBest:0, streak:0, lastDone:null },
  { title: "Read", icon:"üìñ", frequency:"daily", goal:1, checkedDays:[], streakBest:0, streak:0, lastDone:null }
];

/* ---------- persistence: local guest ---------- */
function loadGuest(){
  try{
    const raw = localStorage.getItem(LOCAL_KEY);
    if(!raw) return { habits: SAMPLE_HABITS.slice(), xp:0, stats:{ totalCompletions:0 }, achievements:{} };
    return JSON.parse(raw);
  } catch(e){ return { habits: SAMPLE_HABITS.slice(), xp:0, stats:{ totalCompletions:0 }, achievements:{} }; }
}
function saveGuest(state){
  localStorage.setItem(LOCAL_KEY, JSON.stringify(state));
}

/* ---------- firestore helpers (if enabled) ---------- */
let db = null;
let auth = null;
if(firebaseEnabled){
  // firebase will be initialized later when config is present
}

/* ---------- UI helpers ---------- */
function openAuthModal(mode='login'){
  $('#authModal').style.display = 'flex';
  $('#authTitle').textContent = mode === 'login' ? 'Login' : mode === 'signup' ? 'Sign up' : 'Forgot password';
  $('#loginForm').style.display = mode === 'login' ? '' : 'none';
  $('#signupForm').style.display = mode === 'signup' ? '' : 'none';
  $('#forgotForm').style.display = mode === 'forgot' ? '' : 'none';
}
function closeAuthModal(){ $('#authModal').style.display = 'none'; }

/* ---------- UI: show state ---------- */
function setSignedInUI(email){
  $('#signedInfo').style.display = ''; $('#signedInfo').textContent = email;
  $('#btnGuest').style.display = 'none'; $('#btnAuth').style.display = 'none';
  // add sign out button
  if(!$('#btnSignOut')){
    const btn = document.createElement('button'); btn.id='btnSignOut'; btn.className='btn secondary'; btn.textContent='Sign out';
    btn.onclick = signOutUser; document.querySelector('.toolbar').appendChild(btn);
  }
}
function setSignedOutUI(){
  $('#signedInfo').style.display = 'none';
  $('#btnGuest').style.display = ''; $('#btnAuth').style.display = '';
  if($('#btnSignOut')) $('#btnSignOut').remove();
}

/* ---------- core logic ---------- */

// current in-memory state (works for guest and user after load)
let appState = null;

/* load either guest state or user state from Firestore */
async function loadAppState(){
  if(isGuest){
    appState = loadGuest();
    renderAll();
    return;
  }
  // user mode: load from Firestore
  if(!firebaseEnabled || !db || !currentUser) {
    console.warn('Firestore unavailable ‚Äî falling back to guest mode');
    isGuest = true; loadAppState(); return;
  }
  try{
    const docRef = db.collection('users').doc(currentUser).collection('private').doc(FIRESTORE_USER_DOC);
    const snap = await docRef.get();
    if(!snap.exists){
      // create document from guest state if present, else default
      appState = loadGuest();
      await docRef.set(appState);
    } else {
      appState = snap.data();
    }
    renderAll();
  } catch(err){
    console.error('Failed to load user state:', err);
    appState = loadGuest();
    renderAll();
  }
}

/* save appState to appropriate storage */
async function saveAppState(){
  if(!appState) return;
  if(isGuest){
    saveGuest(appState);
    renderAll();
    return;
  }
  if(!firebaseEnabled || !db || !currentUser){
    console.warn('Firestore not ready ‚Äî saving locally');
    saveGuest(appState);
    renderAll(); return;
  }
  try{
    const docRef = db.collection('users').doc(currentUser).collection('private').doc(FIRESTORE_USER_DOC);
    await docRef.set(appState);
    renderAll();
  } catch(err){
    console.error('Failed to save to Firestore:', err);
    // fallback local save
    saveGuest(appState);
    renderAll();
  }
}

/* ---------- app operations: add habit, toggle, delete ---------- */
function addHabitFromForm(e){
  e.preventDefault();
  const title = $('#habitTitle').value.trim();
  const icon = $('#habitIcon').value || '‚úÖ';
  const frequency = $('#habitFreq').value;
  const goal = Math.max(1, parseInt($('#habitGoal').value || 1));
  if(!title) return alert('Enter habit name');
  appState.habits = appState.habits || [];
  // avoid duplicate
  if(appState.habits.some(h=>h.title.toLowerCase()===title.toLowerCase())){
    return alert('Habit already exists');
  }
  appState.habits.push({ title, icon, frequency, goal, checkedDays:[], streak:0, streakBest:0, lastDone:null });
  $('#addHabitForm').reset();
  saveAppState();
}

/* toggle today's completion (or weekly) */
function toggleComplete(idx){
  const h = appState.habits[idx];
  const key = h.frequency === 'daily' ? todayKey() : weekKey();
  h.checkedDays = h.checkedDays || [];
  const already = h.checkedDays.includes(key);
  if(!already){
    h.checkedDays.push(key);
    // update streak
    const last = h.lastDone ? new Date(h.lastDone) : null;
    const nowDate = new Date(key);
    if(!last) h.streak = 1;
    else {
      const diff = (nowDate - last) / 864e5;
      if((h.frequency==='daily' && diff === 1) || (h.frequency==='weekly' && diff >=6 && diff <=8)) h.streak = (h.streak||0)+1;
      else h.streak = 1;
    }
    h.lastDone = key;
    h.streakBest = Math.max(h.streakBest || 0, h.streak || 0);
    appState.stats.totalCompletions = (appState.stats.totalCompletions || 0) + 1;
    grantXP(10);
    checkAchievements();
  } else {
    // undo last instance
    const i = h.checkedDays.lastIndexOf(key);
    if(i !== -1) h.checkedDays.splice(i,1);
    // (we keep streaks as historical; recalculating exact streaks from scratch is possible but omitted here)
    appState.stats.totalCompletions = Math.max(0, (appState.stats.totalCompletions||0)-1);
  }
  saveAppState();
}

/* delete habit */
function deleteHabit(idx){
  if(!confirm('Delete this habit?')) return;
  appState.habits.splice(idx,1);
  saveAppState();
}

/* ---------- Achievements & XP ---------- */
function grantXP(n){
  appState.xp = (appState.xp||0) + n;
}
function xpToNext(level){ return 100 * level; } // simple curve
function getLevelInfo(){
  let xp = appState.xp||0;
  let level = 1;
  while(xp >= xpToNext(level)){ xp -= xpToNext(level); level++; }
  return { level, xp, xpForNext: xpToNext(level) };
}

/* achievement checks */
const ACHS = [
  { id:'first', title:'First Completion', cond: s => (s.stats.totalCompletions||0) >= 1, emoji:'üéâ' },
  { id:'streak5', title:'5-Day Streak', cond: s => s.habits.some(h=> (h.streakBest||0) >= 5 ), emoji:'üî•' },
  { id:'streak10', title:'10-Day Streak', cond: s => s.habits.some(h=> (h.streakBest||0) >= 10 ), emoji:'üèÜ' },
  { id:'comp20', title:'20 Completions', cond: s => (s.stats.totalCompletions||0) >= 20, emoji:'ü•≥' }
];
function checkAchievements(){
  const unlocked = [];
  appState.achievements = appState.achievements || {};
  ACHS.forEach(a=>{
    if(!appState.achievements[a.id] && a.cond(appState)){
      appState.achievements[a.id] = Date.now();
      unlocked.push(a);
    }
  });
  if(unlocked.length){
    unlocked.forEach(a=>{
      showPopup(`${a.emoji} ${a.title}`, `${a.title} unlocked`);
    });
    grantXP( Math.max(15, unlocked.length * 12) );
  }
}

/* ---------- UI render ---------- */
function renderAll(){
  // habits list
  $('#habitsContainer').innerHTML = '';
  (appState.habits || []).forEach((h, idx)=>{
    const div = document.createElement('div'); div.className = 'habit-row';
    const icon = document.createElement('div'); icon.className='icon'; icon.textContent = h.icon || '‚úÖ';
    const info = document.createElement('div'); info.style.flex='1';
    const title = document.createElement('div'); title.innerHTML = `<strong>${escapeHtml(h.title)}</strong> <span class="small">‚Ä¢ ${capitalize(h.frequency)} ‚Ä¢ goal ${h.goal}</span>`;
    const progWrap = document.createElement('div'); progWrap.className='progress-bar';
    const pct = Math.min(((h.checkedDays||[]).length / (h.goal||1))*100, 100);
    progWrap.innerHTML = `<div class="progress" style="width:${pct}%"></div>`;
    info.appendChild(title); info.appendChild(progWrap);
    const btns = document.createElement('div'); btns.className='actions';
    const todayKeyValue = (h.frequency==='daily' ? todayKey() : weekKey());
    const doneToday = (h.checkedDays||[]).includes(todayKeyValue);
    const toggleBtn = document.createElement('button'); toggleBtn.className='btn'; toggleBtn.textContent = doneToday ? 'Undo' : 'Mark'; toggleBtn.onclick = ()=>toggleComplete(idx);
    const delBtn = document.createElement('button'); delBtn.className='btn secondary'; delBtn.textContent='Delete'; delBtn.onclick = ()=>deleteHabit(idx);
    btns.appendChild(toggleBtn); btns.appendChild(delBtn);
    div.appendChild(icon); div.appendChild(info); div.appendChild(btns);
    $('#habitsContainer').appendChild(div);
  });

  // badges
  const badges = [];
  (appState.habits||[]).forEach(h=>{
    if((h.streakBest||0) >= 5) badges.push(`üî• 5-day: ${h.title}`);
    if((h.streakBest||0) >= 10) badges.push(`üèÜ 10-day: ${h.title}`);
    if((h.checkedDays||[]).length >= 20) badges.push(`üéØ 20 completions: ${h.title}`);
  });
  $('#badgeContainer').innerHTML = badges.length ? badges.map(b=>`<div class="badge" style="display:inline-block;margin-right:6px">${escapeHtml(b)}</div>`).join('') : 'No badges yet ‚Äî earn streaks to unlock awards.';

  // achievements
  const achEls = [];
  for(const a of ACHS){
    const unlocked = !!(appState.achievements && appState.achievements[a.id]);
    achEls.push(`<div style="padding:8px;border-radius:8px;background:${unlocked?'#f0fff6':'#fafafa'};margin-bottom:6px">${a.emoji} <strong>${a.title}</strong><div class="small">${a.cond(appState)?'Unlocked':'Locked'}</div></div>`);
  }
  $('#achList').innerHTML = achEls.join('');

  // level bar
  const li = getLevelInfo();
  const pct = Math.round((li.xp / li.xpForNext)*100);
  $('#levelFill').style.width = pct + '%';

  // chart
  renderChart();

  // signed UI
  if(!isGuest && currentUser){
    setSignedInUI(currentUserEmail||'');
  } else {
    setSignedOutUI();
  }
}

/* ---------- Chart ---------- */
let chartInstance = null;
function renderChart(){
  const ctx = document.getElementById('chartCanvas').getContext('2d');
  const days = 14; const labels = [];
  for(let i=days-1;i>=0;i--){ const d = new Date(); d.setDate(d.getDate()-i); labels.push(d.toISOString().slice(0,10)); }
  const datasets = (appState.habits || []).map((h, idx)=>{
    const arr = new Array(days).fill(0);
    (h.checkedDays || []).forEach(dt=>{
      const i = labels.indexOf(dt);
      if(i>=0) arr[i] = Math.min(arr[i]+1, h.goal);
    });
    const data = arr.map(v => Math.round((v/h.goal)*100));
    return { label: h.title, data, borderColor: randomColor(h.title), tension:0.25, fill:false };
  });
  const cfg = { type:'line', data:{ labels, datasets }, options:{ responsive:true, plugins:{legend:{position:'bottom'}}, scales:{y:{min:0,max:100,ticks:{callback:v=>v+'%'}} } } };
  if(chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, cfg);
}

/* ---------- random color ---------- */
const colorCache = {};
function randomColor(key){
  if(colorCache[key]) return colorCache[key];
  let hash=0; for(let i=0;i<key.length;i++) hash = key.charCodeAt(i) + ((hash<<5)-hash);
  let c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
  c = '00000'.substring(0,6-c.length) + c;
  colorCache[key] = '#'+c;
  return colorCache[key];
}

/* ---------- popups ---------- */
function showPopup(title, msg){
  const p = document.createElement('div'); p.className='modal'; p.style.background='transparent';
  p.innerHTML = `<div class="box" style="transform:translateY(-10px);max-width:420px"><h3>${escapeHtml(title)}</h3><p class="small">${escapeHtml(msg)}</p></div>`;
  document.body.appendChild(p);
  setTimeout(()=> p.remove(), 2600);
}

/* ---------- helpers ---------- */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]); }

/* ---------- initial boot ---------- */
let currentUserEmail = '';
async function boot(){
  // guest default
  isGuest = true;
  currentUser = null;
  appState = loadGuest();
  renderAll();
}
boot();

/* ---------- button handlers ---------- */
$('#addHabitForm').addEventListener('submit', addHabitFromForm);
$('#btnClear').addEventListener('click', ()=>{ if(confirm('Clear local guest data?')){ localStorage.removeItem(LOCAL_KEY); appState = loadGuest(); renderAll(); } });
$('#btnGuest').addEventListener('click', ()=>{ isGuest=true; currentUser=null; appState=loadGuest(); renderAll(); alert('You are in guest mode (data stored locally in this browser).'); });
$('#btnAuth').addEventListener('click', ()=>{ openAuthModal('login'); });

// auth modal controls
$('#btnCloseAuth').onclick = closeAuthModal;
$('#btnSwitchToSignup').onclick = ()=> openAuthModal('signup');
$('#btnSwitchToLogin').onclick = ()=> openAuthModal('login');
$('#btnForgot').onclick = ()=> openAuthModal('forgot');
$('#btnForgotBack').onclick = ()=> openAuthModal('login');

/* ---------- AUTH (Firebase) ---------- */
/* The following block initializes Firebase if you pasted config above.
   If firebaseConfig is not provided the app stays in guest-only mode.
   Replace the placeholder firebaseConfig with your values (instructions are above). */

async function initFirebaseIfAvailable(){
  try{
    if(typeof firebase === 'undefined') { console.warn('Firebase SDK not loaded'); return false; }
    // check if user set window.__FIREBASE_CONFIG__ externally; otherwise skip
    if(!window.__FIREBASE_CONFIG__) return false;
    firebase.initializeApp(window.__FIREBASE_CONFIG__);
    auth = firebase.auth();
    db = firebase.firestore();
    // auth state listener
    auth.onAuthStateChanged(async user=>{
      if(user){
        // signed in
        isGuest = false;
        currentUser = user.uid;
        currentUserEmail = user.email || '';
        setSignedInUI(currentUserEmail);
        // load user state
        await loadAppState();
      } else {
        // signed out
        currentUser = null;
        currentUserEmail = '';
        isGuest = true;
        appState = loadGuest();
        setSignedOutUI();
        renderAll();
      }
    });
    return true;
  }catch(e){ console.warn('Firebase init failed', e); return false; }
}

/* signup/login/reset handlers (rely on firebase if available) */
$('#btnSignup').onclick = async ()=>{
  if(!window.__FIREBASE_CONFIG__){ alert('Firebase not configured. Sign up requires Firebase.'); return; }
  const email = $('#signupEmail').value.trim(), pass = $('#signupPass').value;
  if(!email || !pass) return alert('Enter email and password');
  try{
    await auth.createUserWithEmailAndPassword(email, pass);
    alert('Account created. Your guest data can be merged manually later.');
    closeAuthModal();
  }catch(err){ alert('Signup failed: '+err.message); }
};

$('#btnLogin').onclick = async ()=>{
  if(!window.__FIREBASE_CONFIG__){ alert('Firebase not configured. Login requires Firebase.'); return; }
  const email = $('#loginEmail').value.trim(), pass = $('#loginPass').value;
  if(!email || !pass) return alert('Enter email and password');
  try{
    await auth.signInWithEmailAndPassword(email, pass);
    closeAuthModal();
    // after sign-in, Firestore onAuthStateChanged will load user data
  }catch(err){ alert('Login failed: '+err.message); }
};

$('#btnSendReset').onclick = async ()=>{
  if(!window.__FIREBASE_CONFIG__){ alert('Firebase not configured.'); return; }
  const email = $('#forgotEmail').value.trim(); if(!email) return alert('Enter email');
  try{ await auth.sendPasswordResetEmail(email); alert('Check your inbox for reset link'); closeAuthModal(); } catch(err){ alert('Error: '+err.message); }
};

/* sign out */
async function signOutUser(){
  if(auth){ await auth.signOut(); isGuest=true; currentUser=null; appState = loadGuest(); renderAll(); alert('Signed out'); }
  else { isGuest=true; currentUser=null; appState=loadGuest(); renderAll(); alert('Switched to guest'); }
}

/* helper to allow developer to paste config at runtime
   Paste your firebase config in browser console as:
   window.__FIREBASE_CONFIG__ = { apiKey: "...", authDomain: "...", projectId: "...", ... }
   then run: initFirebaseIfAvailable()
*/
window.initFirebaseIfAvailable = initFirebaseIfAvailable;

/* ---------- run chart after initial boot ---------- */
window.addEventListener('load', ()=>{ setTimeout(()=>{ renderChart(); }, 250); });

/* ---------- run achievements check occasionally ---------- */
setInterval(()=>{ checkAchievements(); saveAppState(); }, 15000);

</script>
</body>
</html>
