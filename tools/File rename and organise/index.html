<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Folder File Renamer Using Excel</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f6f8fa;
    padding: 30px;
    max-width: 800px;
    margin: auto;
  }
  h2 {
    text-align: center;
    margin-bottom: 10px;
  }
  .description {
    font-size: 16px; 
    color: #333;
    margin-bottom: 25px;
    text-align: center;
  }
  label {
    font-weight: bold;
    display: block;
    margin: 12px 0 8px;
  }
  input[type="file"] {
    width: 100%;
    padding: 8px;
    font-size: 15px;
    box-sizing: border-box;
    margin-bottom: 12px;
  }
  button {
    padding: 12px 18px;
    font-size: 16px;
    margin-top: 10px;
    background: #66aaff;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }
  button:disabled {
    background: #a0cdfd;
    cursor: not-allowed;
  }
  #fileCount {
    margin-top: 10px;
    font-style: italic;
    color: #333;
    text-align: center;
  }
  #fileListTitle {
    margin-top: 30px;
    font-weight: bold;
    text-align: center;
  }
  #issueLog {
    margin-top: 20px;
    font-family: monospace;
    white-space: pre-wrap;
    background: #fff;
    border: 1px solid #ccc;
    padding: 10px;
    border-radius: 6px;
    max-height: 220px;
    overflow-y: auto;
  }
  #securityNotice {
    margin-top: 15px;
    font-size: 14px;
    color: #b35050;
    background: #fff8f8;
    border: 1px solid #f4c1c1;
    padding: 12px;
    border-radius: 6px;
  }
  .promo {
    margin-top: 40px;
    background: #ffeee6;
    padding: 15px;
    border-radius: 8px;
    font-size: 15px;
    color: #333;
    text-align: center;
  }
</style>
</head>
<body>

<h2>Folder File Renamer Using Excel</h2>

<div class="description">
  This tool lets you bulk-rename files in a selected folder: export file info to Excel (including file types), edit new file names, then upload to rename and download all files in a ZIP.<br>
  After downloading the ZIP, extract it to recreate your folder structure with new file names safely.
</div>

<label for="folderInput">Select Folder:</label>
<input type="file" id="folderInput" webkitdirectory multiple />

<button id="exportExcelBtn" disabled>Export File List to Excel</button>

<label for="excelInput" style="margin-top:25px;">Upload Edited Excel with New Names:</label>
<input type="file" id="excelInput" accept=".xlsx,.xls" disabled />

<button id="downloadZipBtn" disabled>Download Renamed Files as ZIP</button>

<div id="fileCount"></div>
<div id="fileListTitle" style="display:none;">Note: Original folder paths are preserved inside ZIP; only file names are changed.</div>
<div id="issueLog"></div>

<div id="securityNotice" style="display:none;">
  <strong>Important:</strong> Windows or your antivirus may warn about the ZIP file downloaded from the internet.<br>
  To safely proceed:<br>
  <ul>
    <li>Right-click the ZIP file, select <em>"Properties"</em>, then check <em>"Unblock"</em> if present, and click OK.</li>
    <li>Extract the ZIP using your file explorer or tools like 7-Zip or WinRAR.</li>
    <li>If Windows SmartScreen warns you, click <em>"More Info"</em> &gt; <em>"Run Anyway"</em> if you trust this source.</li>
  </ul>
</div>

<div class="promo">
  For more automations visit and follow:<br>
  <b>https://effortlessautomation.wordpress.com/</b><br>
  <b>Contact:</b> decomplicate001@gmail.com
</div>

<!-- Dependencies -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script>
  const folderInput = document.getElementById('folderInput');
  const exportExcelBtn = document.getElementById('exportExcelBtn');
  const excelInput = document.getElementById('excelInput');
  const downloadZipBtn = document.getElementById('downloadZipBtn');
  const fileCountDiv = document.getElementById('fileCount');
  const issueLogDiv = document.getElementById('issueLog');
  const fileListTitle = document.getElementById('fileListTitle');
  const securityNoticeDiv = document.getElementById('securityNotice');

  let filesMap = new Map(); // key: webkitRelativePath, value: File object
  let renamedMap = new Map(); // key: webkitRelativePath, value: new filename string

  folderInput.addEventListener('change', () => {
    issueLogDiv.textContent = "";
    securityNoticeDiv.style.display = "none";
    filesMap.clear();
    renamedMap.clear();

    const files = Array.from(folderInput.files);
    if (files.length === 0) {
      exportExcelBtn.disabled = true;
      excelInput.disabled = true;
      downloadZipBtn.disabled = true;
      fileCountDiv.textContent = "No files selected.";
      fileListTitle.style.display = "none";
      return;
    }

    files.forEach(file => {
      filesMap.set(file.webkitRelativePath, file);
      renamedMap.set(file.webkitRelativePath, file.name);
    });

    exportExcelBtn.disabled = false;
    excelInput.disabled = false;
    downloadZipBtn.disabled = true;

    fileCountDiv.textContent = `${files.length} file(s) selected in folder.`;
    fileListTitle.style.display = "block";
  });

  exportExcelBtn.addEventListener('click', () => {
    if (filesMap.size === 0) {
      alert("Please select a folder first.");
      return;
    }
    const data = [];
    for (const [relPath, file] of filesMap.entries()) {
      const ext = file.name.includes('.') ? file.name.split('.').pop().toLowerCase() : '';
      data.push({
        "Original Name": relPath,
        "File Type": ext,
        "New Name": renamedMap.get(relPath) || file.name
      });
    }

    const ws = XLSX.utils.json_to_sheet(data, { header: ["Original Name", "File Type", "New Name"] });
    ws['!cols'] = [{wch: 60}, {wch: 15}, {wch: 40}];
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "FilesToRename");

    XLSX.writeFile(wb, "files_to_rename.xlsx");
  });

  excelInput.addEventListener('change', e => {
    issueLogDiv.textContent = "";
    securityNoticeDiv.style.display = "none";

    if (filesMap.size === 0) {
      alert("Please select the folder first.");
      e.target.value = "";
      return;
    }

    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (evt) => {
      try {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

        let updatesCount = 0;
        let invalidRows = [];

        jsonData.forEach((row, idx) => {
          const origName = row['Original Name'] || "";
          const newName = row['New Name'] || "";
          if (!origName || !newName) {
            invalidRows.push(idx + 2); // Excel row index (including header)
            return;
          }
          if (filesMap.has(origName)) {
            // No slashes/backslashes in new name allowed
            if (newName.includes('/') || newName.includes('\\')) {
              invalidRows.push(idx + 2);
              return;
            }
            renamedMap.set(origName, newName);
            updatesCount++;
          }
        });

        if (updatesCount === 0) {
          issueLogDiv.style.color = "red";
          issueLogDiv.textContent = "No matching original filenames found or no valid new names.";
          downloadZipBtn.disabled = true;
          return;
        }

        issueLogDiv.style.color = "green";
        issueLogDiv.textContent = `Successfully updated ${updatesCount} file name(s).`;
        if (invalidRows.length > 0) {
          issueLogDiv.textContent += "\nWarning: Invalid new names at Excel rows: " + invalidRows.join(", ") + ".\nNew names must not contain slashes.";
        }
        downloadZipBtn.disabled = false;
      } catch (err) {
        alert("Failed to read Excel file: " + err.message);
        downloadZipBtn.disabled = true;
      }
    };
    reader.readAsArrayBuffer(file);
    e.target.value = "";
  });

  downloadZipBtn.addEventListener('click', async () => {
    if (filesMap.size === 0) {
      alert("Please select files first.");
      return;
    }
    issueLogDiv.textContent = "";
    securityNoticeDiv.style.display = "none";

    const zip = new JSZip();
    let zipErrorLog = [];

    for (const [relPath, file] of filesMap.entries()) {
      try {
        const newName = renamedMap.get(relPath) || file.name;
        const folderPath = relPath.includes('/') ? relPath.substring(0, relPath.lastIndexOf('/')) : "";
        const zipPath = folderPath ? `${folderPath}/` : "";

        zip.file(zipPath + newName, await file.arrayBuffer());
      } catch (err) {
        zipErrorLog.push(`Failed to process file: ${relPath} - ${err.message}`);
      }
    }

    if (zipErrorLog.length > 0) {
      issueLogDiv.style.color = 'red';
      issueLogDiv.textContent = "Some files could not be processed:\n" + zipErrorLog.join("\n");
    } else {
      issueLogDiv.style.color = 'green';
      issueLogDiv.textContent = "All files processed and added to ZIP.";
    }

    zip.generateAsync({ type: "blob" }).then(blob => {
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "renamed_files.zip";
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 1500);
      securityNoticeDiv.style.display = "block";
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    });
  });
</script>

</body>
</html>
